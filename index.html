
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RECO v31.9</title>
  <link rel="stylesheet" href="style.css"/>
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div id="loginOverlay">
    <div id="loginCard"><h2>Logg inn</h2><button id="btnOverlayLogin">Logg inn</button></div>
  </div>
  <header><nav><a href="#/dashboard">Dashboard</a><a href="#/kalkyle">Kalkyle Pro</a><a href="#/rapport">Rapport</a></nav></header>
  <main><section id="view-dashboard"><h1>Dashboard</h1></section></main>
  <script type="module" src="js/app.js"></script>

<!-- Domain enforcement: @reco.no OR specific whitelisted emails -->
<script>
(function(){
  var ALLOWED_DOMAIN = 'reco.no';
  var WHITELIST = ['stianbdon.live.no']; // lowercase

  function hasAccess(user){
    try {
      var email = (user && user.email) || (user && user.user_metadata && user.user_metadata.email) || '';
      email = (email||'').toLowerCase();
      if (email.endsWith('@' + ALLOWED_DOMAIN)) return true;
      if (WHITELIST.indexOf(email) !== -1) return true;
      return false;
    } catch(e){ return false; }
  }

  function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var overlay = document.getElementById('loginOverlay');

    function rejectUser(reason){
      try { window.netlifyIdentity && window.netlifyIdentity.logout(); } catch(e){}
      if (overlay) overlay.style.display = 'block';
      // show message
      try {
        var msg = document.getElementById('domainMsg');
        if (!msg) {
          msg = document.createElement('div');
          msg.id = 'domainMsg';
          msg.style.cssText = 'position:fixed;bottom:16px;right:16px;padding:10px 12px;background:#222;color:#fff;border-radius:8px;z-index:9999;';
          document.body.appendChild(msg);
        }
        msg.textContent = 'Kun brukere med @' + ALLOWED_DOMAIN + ' eller whitelisted e-post har tilgang.';
        setTimeout(function(){ if (msg && msg.parentNode) msg.parentNode.removeChild(msg); }, 5000);
      } catch(e){}
      console.warn('Access denied: email not allowed.', reason||'');
    }

    if (!window.netlifyIdentity) return;
    try { window.netlifyIdentity.init(); } catch(e){}

    var user = window.netlifyIdentity.currentUser();
    if (user) {
      if (!hasAccess(user)) {
        rejectUser('init');
        return;
      }
      if (overlay) overlay.style.display = 'none';
    }

    window.netlifyIdentity.on('login', function(u){
      if (!hasAccess(u)) {
        rejectUser('login');
        return;
      }
      try { window.netlifyIdentity.close(); } catch(e){}
      if (overlay) overlay.style.display = 'none';
    });
  });
})();
</script>

</body>
</html>
